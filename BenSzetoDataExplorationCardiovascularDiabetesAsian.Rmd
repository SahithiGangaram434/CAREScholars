---
title: "Data Exploration Diabetes Cardiovascular Mortality"
author: "Ben Szeto"
date: "2024-06-27"
output: html_document
---

```{r setup, include=FALSE}
#
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# NOTE: To load data, you must download both the extract's data and the DDI
# and also set the working directory to the folder with these files (or change the path below).

if (!require("ipumsr")) stop("Reading IPUMS data into R requires the ipumsr package. It can be installed using the following command: install.packages('ipumsr')")

ddi <- read_ipums_ddi("C:/Users/bszet/Box/CARE Scholars 2024 - Diabetes Mortality Project/Data and Code/nhis_00027.xml")

#"C:\Users\bszet\OneDrive\Documents\Stanford Care Scholars\Diabetes Cardiovascular Outcomes\Data\nhis_00025.xml"

#"C:\Users\bszet\OneDrive\Documents\Stanford Care Scholars\Diabetes Cardiovascular Outcomes\Data\nhis_00025.dat"
data <- read_ipums_micro(ddi)
```


```{r}
library(tidyverse)
library(knitr)
library(plotly)
library(ggeffects)
library(ggformula)
```

```{r}
set.seed(100)
data10k<-data%>%sample_n(10000)#Taking 10,000 random rows from data

```

```{r}
data10k%>% #Note this is from the random sample data so there may be things missing from the population
  lapply(unique)
```

```{r} 

#Counting number of levels for each variable
data10k%>% #Note this is from the random sample data so there may be things missing from the population
  sapply(function(x) length(unique(x)))

```

```{r}
head(data10k)

nrow(data10k)

table(data10k$SEX)
table(data10k$SEX)
table(data10k$RACEA)

nrow(data10k%>%filter(BMICALC==0))
nrow(data10k%>%filter(BMI==0))



data10k%>% #Checking distribution of BMI CALC; How many 0 and 996?
  mutate(BMI_Terms=ifelse(!BMICALC %in% c(0,996), "Within Range", BMICALC))%>%
  group_by(BMI_Terms)%>%
  summarize(
    n()
  )

data10k%>% #What does BMI do when BMI CALC is 996
  filter(BMICALC==996)%>%
  select(BMICALC, BMI,HEIGHT, WEIGHT)%>%
  arrange(desc(BMI))

```

```{r}
table(data10k$USBORN)

```

```{r}


#Distribution of BMICALC
ggplotly(
data10k%>%
  ggplot(aes(x=BMICALC))+
  geom_histogram(binwidth = 1)
)

data10k%>% #checking normality of BMICALC removing 0 and 996
  filter(!BMICALC %in% c(0, 996))%>%
  ggplot(aes(sample=BMICALC))+
  geom_qq()+
  geom_qq_line()

data10k%>% #checking normality of BMICALC removing 0 and 996
  filter(!BMICALC %in% c(0, 996))%>%
  ggplot(aes(x=BMICALC))+
  geom_histogram()



```
```{r}
library(corrplot)
cordata<-data10k%>%
  select(YEAR, AGE, SEX, MARSTCUR, RACEA, HISPYN, USBORN, EDUCREC2, EMPSTAT, POORYN, EARNINGS, OWNERSHIP, BMICALC, HEIGHT, WEIGHT, CHEARTDIEV, DIABETICEV, HEARTATTEV, HEARTCONEV, STROKEV, ALCSTAT1, SMOKESTATUS2, MOD10DMIN)
cordata_cor<-cor(cordata)


cordata_cor
corrplot(cordata_cor)
```





```{r prevalences of diseases}

# 
#   pivot_longer(
#     NHISHID,
#     names_to="Variable",
#     values_to="Level"
#   )

```



```{r}
library(janitor)


```



##Data Processing/Intial Univariate Analysis
```{r}
race_sub_data<-data%>%
  mutate(racea=as_factor(RACEA))#%>%
  #filter(racea%in%c("White", "Filipino", "Chinese", "Asian Indian", "Korean", "Vietnamese", "Japanese", "Pacific Islander"))

data.frame(table(race_sub_data$racea))%>%#Freq table of different Asian Races. As you can see only Filipino, Chinese, Asian Indian. Remove above # to see more
  arrange(desc(Freq))

```

```{r}

data10k<-data10k%>%#New variable called sex based on SEX variable
  mutate(sex=case_when(SEX==1~"male",
                       SEX==2~"female",
                       SEX%in%c(7,8,9)~"Unknown")#Single value for all reason unknown
         )
data10k%>%#bar plot for sex
  ggplot(aes(x=sex))+
  geom_bar()

data10k$RACEA2<-as_factor(data10k$RACEA)

data10k<-data10k%>%#new column that uses labels for race rather than code
  mutate(racea=as_factor(RACEA))

data10k%>% #Race bar plot
   ggplot(aes(x=racea))+
  geom_bar()


data.frame(prop.table(table(data10k$racea))*100)%>%rename(Percent=Freq)%>%arrange(desc(Percent)) # GO BACK AND TRY TO DO W/ JANITOR PACKAGE WITH LAPPLY


```

```{r}
#Distribution of BMI


# data10k%>%
#   ggplot(aes(x=BMI))+
#   geom_histogram(binwidth = 1)

data%>%
  select(BMI, BMICALC)%>%
  filter(!BMICALC==996)%>%
  filter(!BMI==0)%>%
  filter(!BMI>98)%>%
  filter(!BMI-BMICALC>1)%>%#Testing to see if they are all close in value
  ggplot()+
  geom_histogram(aes(x=BMI))#Distribution of BMI


data%>%#Determining number of BMI values we have for each race
  filter(!BMICALC==996)%>%
  filter(!BMI==0)%>%
  filter(!BMI>98)%>%
  filter(!BMI-BMICALC>1)%>%
  mutate(racea=as_factor(RACEA))%>%
  filter(racea%in%c("White", "Chinese", "Filipino", "Asian Indian"))%>%
  group_by(racea)%>%
  summarize(
    n(),
    mean(BMI),
    sd(BMI)
  )
```
```{r, looking into creating composite}


data%>%
  select(CHEARTDIEV, CONGHARTEV, HEARTATTEV, HEARTCONEV, HYPERTENEV, STROKEV)%>% #Columns you want to make a frequency table for
  lapply(as_factor)%>%
  lapply(table)%>%
  as.data.frame()

data%>%
  select(CHEARTDIEV, CONGHARTEV, HEARTATTEV, HEARTCONEV, HYPERTENEV, STROKEV)%>%#need to make a way to ignore missing/unknown
  filter(across(c(CHEARTDIEV, CONGHARTEV, HEARTATTEV, HEARTCONEV, HYPERTENEV, STROKEV), ~ . %in% c(1, 2)))%>%#There are now observations with zero not in universe values
  mutate(sum_disease=(CHEARTDIEV+CONGHARTEV+HEARTATTEV+HEARTCONEV+HYPERTENEV+STROKEV))#%>%
  # filter(sum_disease>0)%>%
  # ggplot(aes(x=sum_disease))+
  # geom_boxplot()




```

Model Practice

```{r}
table(data$CHEARTDIEV)
unique(data$CHEARTDIEV)
```
```{r}

CHEARTDIEV_data<-data%>%
  filter(CHEARTDIEV%in%c(1,2))%>%
  mutate(CHEARTDIEV_binary=case_when(CHEARTDIEV==1~0,
                                     CHEARTDIEV==2~1))%>%
  mutate(racea=as_factor(RACEA))%>%
  filter(racea%in%c("White", "Filipino", "Chinese", "Asian Indian"))

table(CHEARTDIEV_data$CHEARTDIEV_binary)

CHEARTDIEV_glm<-glm(CHEARTDIEV_binary~BMI+racea+BMI:racea, data=CHEARTDIEV_data, family="binomial")

summary(CHEARTDIEV_glm)#base case is white with 0 BMI

#Testing residuals

CHEARTDIEV_aug<-augment(CHEARTDIEV_glm,CHEARTDIEV_data)%>%
  dplyr::mutate(.resp.resid=resid(CHEARTDIEV_glm, type="response"))

arm::binnedplot(CHEARTDIEV_aug$BMI, CHEARTDIEV_aug$.resp.resid, col.int = NULL)#Clear trend need to apply transformation



CHEARTDIEV_bmi <- ggpredict(CHEARTDIEV_glm, terms = c("BMI", "racea"))

plot(CHEARTDIEV_bmi)#Be sure to limit x axis domain

```
